package com.devengers.service.sessionmanagement;

import org.json.JSONObject;
import org.springframework.amqp.core.Message;
import org.springframework.beans.factory.annotation.Autowired;

import org.springframework.amqp.core.MessageListener;

import com.devengers.service.sessionmangement.controller.SessionServiceResource;
import com.devengers.service.sessionmangement.model.UserSessionDetail;
import com.devengers.service.sessionmangement.repository.SessionDetailsRepository;

public class Consumer implements MessageListener{
	 String str ="";
		@Autowired
	    SessionDetailsRepository quotesRepository;
		
		SessionServiceResource ssr = new SessionServiceResource();
		
		
		@Override
	 public void onMessage(Message message) {
		
	        System.out.println(new String(message.getBody()));
	        byte[] body = message.getBody();
	        str = new String(body);
	        JSONObject json = new JSONObject(str);
	        System.out.println(json.toString());
	        int user= (int) json.get("userid");
	        int correl = (int) json.get("correlationid");
	        int files = (int) json.get("no_of_files");
	        System.out.println("userid is: "+user);
	        System.out.println("correl is :"+correl);

	        System.out.println("files is :"+files);
	        
	        UserSessionDetail usersessiondetail = new UserSessionDetail();
	        usersessiondetail.setUserId(user);
	        usersessiondetail.setCorrelationId(correl);
	        usersessiondetail.setNo_of_files(files);
	        quotesRepository.save(usersessiondetail);
	        
	        ssr.details(usersessiondetail);
			
	        System.out.println("Do we reach here ");
	    }

}
