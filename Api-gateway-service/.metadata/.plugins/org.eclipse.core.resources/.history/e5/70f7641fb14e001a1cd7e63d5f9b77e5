package com.ads.devengers.sessionmanagement.rabbitmq;

import org.json.JSONObject;
import org.springframework.amqp.core.Message;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.stereotype.Component;
import org.springframework.amqp.core.MessageListener;


@EnableJpaRepositories(basePackages = "com.devengers.service.sessionmanagement.repository")
@Component
public class Consumer implements MessageListener{
	
	 String str =`"";
	 
		@Autowired
	   private SessionDetailsRepository quotesRepository;
		
		SessionServiceResource ssr = new SessionServiceResource();
		
		
		@Override
	 public void onMessage(Message message) {
		
	        System.out.println(new String(message.getBody()));
	        byte[] body = message.getBody();
	        str = new String(body);
	        JSONObject json = new JSONObject(str);
	        System.out.println(json.toString());
	        int user= (int) json.get("userid");
	        int correl = (int) json.get("correlationid");
	        int files = (int) json.get("no_of_files");
	        System.out.println("userid is: "+user);
	        System.out.println("correl is :"+correl);

	        System.out.println("files is :"+files);
	        
	        UserSessionDetail usersessiondetail = new UserSessionDetail();
	        usersessiondetail.setUserId(user);
	        usersessiondetail.setCorrelationId(correl);
	        usersessiondetail.setNo_of_files(files);
	        System.out.println("**********"+usersessiondetail);
	        quotesRepository.save(usersessiondetail);
	        
	       // ssr.details(usersessiondetail);
			
	        System.out.println("Do we reach here ");
	    }

}
